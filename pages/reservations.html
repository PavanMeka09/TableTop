<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TableTop | Reservations</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-md sticky top-0 z-40 mb-8">
        <div class="container mx-auto px-8">
            <div class="flex justify-between items-center py-4">
                <a href="../index.html" class="flex items-center space-x-2">
                    <i class="fas fa-utensils text-amber-600 text-2xl"></i>
                    <h1 class="text-2xl font-bold text-amber-600">TableTop</h1>
                </a>
                <div class="hidden md:flex items-center space-x-8 text-lg font-medium">
                    <a href="../index.html" class="hover:text-amber-600 transition-colors flex items-center gap-1"><i class="fas fa-home"></i> Home</a>
                    <a href="menu.html" class="hover:text-amber-600 transition-colors">Menu</a>
                    <a href="reservations.html" class="hover:text-amber-600 transition-colors">Reservations</a>
                    <a href="trackorder.html" class="hover:text-amber-600 transition-colors flex items-center gap-1"><i class="fas fa-truck"></i> Track Order</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="login.html" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors shadow-md login-btn">Login</a>
                    <button id="mobile-menu-button" class="md:hidden text-gray-700"><i class="fas fa-bars text-2xl"></i></button>
                </div>
            </div>
            <div id="mobile-menu" class="md:hidden hidden py-4 border-t border-gray-100 px-8">
                <a href="../index.html" class="block py-2 text-gray-700 hover:text-amber-600 flex items-center gap-1"><i class="fas fa-home"></i> Home</a>
                <a href="menu.html" class="block py-2 text-gray-700 hover:text-amber-600">Menu</a>
                <a href="reservations.html" class="block py-2 text-gray-700 hover:text-amber-600">Reservations</a>
                <a href="trackorder.html" class="block py-2 text-gray-700 hover:text-amber-600 flex items-center gap-1"><i class="fas fa-truck"></i> Track Order</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-8">
        <section class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
    <main class="container mx-auto p-4">
        <!-- Date Selection -->
        <div class="max-w-4xl mx-auto mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">Select Reservation Date</h2>
            <input type="date" id="reservationDate" class="w-40 p-2 rounded border mb-8 text-sm" min="{{today}}">
        </div>
        <!-- Time Slot Selection -->
        <div class="max-w-4xl mx-auto mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">Select Time Slot</h2>
            <div id="timeSlots" class="grid gap-4 md:grid-cols-4"></div>
            <div id="timeFeedback" class="text-center text-red-600 text-sm mt-2"></div>
        </div>
        <!-- Table Selection -->
        <div id="tableSelection" class="max-w-4xl mx-auto hidden">
            <h2 class="text-2xl font-bold mb-4">Available Tables</h2>
            <div id="tablesGrid" class="grid gap-4 md:grid-cols-5"></div>
            <div id="tableFeedback" class="text-center text-red-600 text-sm mt-2"></div>
        </div>
        <div id="confirmationMsg" class="text-center text-green-600 text-lg font-bold mt-8"></div>
    </main>

    <script>
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });
        // Session check and UI update
        document.addEventListener('DOMContentLoaded', async () => {
            const loginButton = document.querySelector('.login-btn');
            const nav = document.querySelector('nav .flex.items-center.space-x-4');
            try {
                const res = await fetch('../backend/auth.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ action: 'check_session' })
                });
                const data = await res.json();
                if (data.logged_in) {
                    loginButton.style.display = 'none';
                    const logout = document.createElement('a');
                    logout.textContent = 'Logout';
                    logout.href = '#';
                    logout.className = 'bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors shadow-md logout-btn';
                    logout.onclick = async function(e) {
                        e.preventDefault();
                        await fetch('../backend/auth.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: new URLSearchParams({ action: 'logout' })
                        });
                        window.location.href = '../index.html';
                    };
                    nav.appendChild(logout);
                } else {
                    window.location.href = 'login.html';
                }
            } catch (e) {
                window.location.href = 'login.html';
            }
        });
        // Remove toast feedback, use inline feedback instead
        function showToast(msg, type = 'info') {}
        // Time slots config
        const TIME_SLOTS = [
            '18:00', '18:30', '19:00', '19:30', '20:00', '20:30', '21:00', '21:30', '22:00'
        ];
        const TABLE_COUNT = 10;
        let selectedTime = null;
        let selectedTable = null;
        // Set today's date as min for date input
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reservationDate').min = today;
            document.getElementById('reservationDate').value = today;
            renderTimeSlots();
            fetchBookedTimes();
        });
        document.getElementById('reservationDate').addEventListener('change', function() {
            selectedTime = null;
            selectedTable = null;
            document.getElementById('tableSelection').classList.add('hidden');
            document.getElementById('confirmationMsg').textContent = '';
            renderTimeSlots();
            fetchBookedTimes();
        });
        // Convert 24-hour time slots to 12-hour format
        function convertTo12HourFormat(time) {
            const [hour, minute] = time.split(':');
            const hourInt = parseInt(hour);
            const period = hourInt >= 12 ? 'PM' : 'AM';
            const hour12 = hourInt % 12 || 12;
            return `${hour12}:${minute} ${period}`;
        }

        function renderTimeSlots(bookedTimes = []) {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            TIME_SLOTS.forEach(slot => {
                const btn = document.createElement('button');
                btn.className = 'bg-white p-2 rounded shadow text-left hover:shadow-md text-sm';
                btn.textContent = convertTo12HourFormat(slot);
                btn.disabled = bookedTimes.includes(slot + ':00');
                if (btn.disabled) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML += ' <span class="text-red-600">(Booked)</span>';
                }
                btn.onclick = () => selectTime(slot);
                container.appendChild(btn);
            });
        }
        function fetchBookedTimes() {
            const date = document.getElementById('reservationDate').value;
            fetch('../backend/reservation.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ action: 'get_booked_times', date })
            })
            .then(res => res.json())
            .then(data => {
                if (data.booked_times) {
                    renderTimeSlots(data.booked_times);
                } else {
                    renderTimeSlots([]);
                }
            });
        }
        function selectTime(time) {
            selectedTime = time;
            document.getElementById('tableSelection').classList.remove('hidden');
            document.getElementById('confirmationMsg').textContent = '';
            renderTables();
            fetchBookedTables();
        }
        function renderTables(bookedTables = []) {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = '';
            for (let i = 1; i <= TABLE_COUNT; i++) {
                const btn = document.createElement('button');
                btn.className = 'bg-white p-4 rounded shadow text-left hover:shadow-md';
                btn.innerHTML = `<h3 class="font-bold">Table ${i}</h3><span class="text-green-600">Available</span>`;
                btn.disabled = bookedTables.includes(i.toString());
                if (btn.disabled) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = `<h3 class="font-bold">Table ${i}</h3><span class="text-red-600">Booked</span>`;
                }
                btn.onclick = () => selectTable(i);
                grid.appendChild(btn);
            }
        }
        function fetchBookedTables() {
            const date = document.getElementById('reservationDate').value;
            if (!selectedTime) return;
            fetch('../backend/reservation.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ action: 'get_booked_tables', date, time: selectedTime })
            })
            .then(res => res.json())
            .then(data => {
                if (data.booked_tables) {
                    renderTables(data.booked_tables);
                } else {
                    renderTables([]);
                }
            });
        }
        async function selectTable(tableNumber) {
            if (!confirm(`Confirm reservation for Table ${tableNumber} at ${selectedTime}?`)) return;
            selectedTable = tableNumber;
            const date = document.getElementById('reservationDate').value;
            if (!date || !selectedTime) return;
            const reservation_time = date + ' ' + selectedTime + ':00';
            const data = new URLSearchParams({
                action: 'create_reservation',
                table_number: selectedTable,
                reservation_time
            });
            document.getElementById('tableFeedback').textContent = 'Booking table...';
            fetch('../backend/reservation.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: data
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('confirmationMsg').textContent = 'Reservation confirmed!';
                    document.getElementById('tableFeedback').textContent = '';
                    document.getElementById('tableSelection').classList.add('hidden');
                } else {
                    document.getElementById('tableFeedback').textContent = data.error || 'Failed to make reservation';
                }
            })
            .catch(error => {
                document.getElementById('tableFeedback').textContent = 'Failed to make reservation';
            });
        }
    </script>
</body>
</html>