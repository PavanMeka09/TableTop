<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TableTop | Reservations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="../js/checkSessionUser.js"></script>
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-md sticky top-0 z-40 mb-8">
        <div class="container mx-auto px-8">
            <div class="flex justify-between items-center py-4">
                <a href="../index.html" class="flex items-center space-x-2">
                    <i class="fas fa-utensils text-amber-600 text-2xl"></i>
                    <h1 class="text-2xl font-bold text-amber-600">TableTop</h1>
                </a>
                <div class="hidden md:flex items-center space-x-14 text-lg font-medium ml-auto">
                    <a href="../index.html" class="hover:text-amber-600 transition-colors flex items-center gap-1"><i class="fas fa-home"></i> Home</a>
                    <a href="menu.html" class="hover:text-amber-600 font-semibold border-amber-600 flex items-center gap-1"><i class="fa-solid fa-list"></i>Menu</a>
                    <a href="reservations.html" class="text-amber-600 transition-colors flex items-center gap-1"><i class="fa-solid fa-calendar"></i>Reservations</a>
                    <a href="trackorder.html" class="hover:text-amber-600 transition-colors flex items-center gap-1"><i class="fas fa-truck"></i> Track Order</a>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="mobile-menu-button" class="md:hidden text-gray-700 cursor-pointer"><i class="fas fa-bars text-2xl"></i></button>
                </div>
            </div>
            <div id="mobile-menu" class="md:hidden hidden py-4 px-8 space-y-6 border-t-2 border-gray-200">
                <a href="../index.html" class="hover:text-amber-600 transition-colors flex items-center gap-1"><i class="fas fa-home"></i> Home</a>
                <a href="menu.html" class="hover:text-amber-600 font-semibold border-amber-600 flex items-center gap-1"><i class="fa-solid fa-list"></i>Menu</a>
                <a href="reservations.html" class="text-amber-600 transition-colors flex items-center gap-1"><i class="fa-solid fa-calendar"></i>Reservations</a>
                <a href="trackorder.html" class="hover:text-amber-600 transition-colors flex items-center gap-1"><i class="fas fa-truck"></i> Track Order</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <!-- Date Selection -->
        <div class="max-w-4xl mx-auto mb-8 bg-white p-6 rounded-lg shadow">
            <h2 class="text-2xl font-bold mb-4 text-center">Select Reservation Date</h2>
            <div class="flex justify-center">
                <input type="date" id="reservationDate" class="w-full max-w-xs p-3 rounded-lg border mb-4 text-sm cursor-pointer focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-300" min="{{today}}" autocomplete="off">
            </div>
        </div>
        
        <!-- Time Slot Selection -->
        <div class="max-w-4xl mx-auto mb-8 bg-white p-6 rounded-lg shadow">
            <h2 class="text-2xl font-bold mb-4 text-center">Select Time Slot</h2>
            <div id="timeSlots" class="flex flex-wrap justify-center gap-4"></div>
            <div id="timeFeedback" class="text-center text-red-600 text-sm mt-4"></div>
        </div>
        
        <!-- Table Selection -->
        <div id="tableSelection" class="max-w-4xl mx-auto hidden bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">Available Tables</h2>
            <div id="tablesGrid" class="flex flex-wrap justify-center gap-4"></div>
            <div id="tableFeedback" class="text-center text-red-600 text-sm mt-4"></div>
        </div>
        
        <div id="confirmationMsg" class="text-center text-green-600 text-lg font-bold mt-8 bg-white p-6 rounded-lg shadow max-w-4xl mx-auto hidden">
            <i class="fas fa-check-circle text-4xl mb-4"></i>
            <p id="confirmationText"></p>
        </div>
    </main>

    <script>
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });
        
        // Time slots config
        // Each slot is now an object with start and end
        const TIME_SLOTS = [
            { start: '18:00', end: '19:00' },
            { start: '19:00', end: '20:00' },
            { start: '20:00', end: '21:00' },
            { start: '21:00', end: '22:00' }
        ];
        const TABLE_COUNT = 10;
        let selectedSlot = null;
        let selectedTable = null;
        let bookedTablesBySlot = {};
        let bookedTablesByTime = {}; // Added to handle the API response format

        // Convert 24-hour time to 12-hour format
        function convertTo12HourFormat(time) {
            const [hour, minute] = time.split(':');
            const hourInt = parseInt(hour);
            const period = hourInt >= 12 ? 'PM' : 'AM';
            const hour12 = hourInt % 12 || 12;
            return `${hour12}:${minute} ${period}`;
        }

        function renderTimeSlots() {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            TIME_SLOTS.forEach(slot => {
                const slotKey = slot.start + '-' + slot.end;
                // Check time with and without seconds
                const timeKey = slot.start + ':00';
                const timeKeyNoSeconds = slot.start;
                
                // Check if the time slot is fully booked
                const bookedTables = bookedTablesByTime[timeKey] || bookedTablesByTime[timeKeyNoSeconds] || [];
                const isFullyBooked = bookedTables.length === TABLE_COUNT;
                
                const btn = document.createElement('button');
                btn.className = 'bg-white p-3 rounded-lg shadow text-center hover:shadow-md text-base w-44 cursor-pointer transition-all duration-200';
                btn.textContent = `${convertTo12HourFormat(slot.start)} to ${convertTo12HourFormat(slot.end)}`;
                btn.dataset.slot = slotKey;
                btn.dataset.timeKey = timeKey;
                btn.disabled = isFullyBooked;
                
                if (isFullyBooked) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-100');
                    btn.innerHTML += '<div class="text-red-600 text-xs mt-1">Booked</div>';
                } else if (selectedSlot && selectedSlot.start === slot.start && selectedSlot.end === slot.end) {
                    btn.classList.add('border-2', 'border-amber-600', 'bg-amber-50');
                }
                
                if (!isFullyBooked) {
                    btn.onclick = () => selectTimeSlot(slot, timeKey);
                }
                container.appendChild(btn);
            });
        }

        function fetchBookedTimes() {
            const date = document.getElementById('reservationDate').value;
            fetch('../backend/reservation.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ action: 'get_booked_times', date })
            })
            .then(res => res.json())
            .then(data => {
                console.log('Received booking data:', data);
                
                // Store both formats of data for compatibility
                bookedTablesByTime = data.booked_tables_by_time || {};
                bookedTablesBySlot = data.booked_tables_by_slot || {};
                
                renderTimeSlots();
            })
            .catch(error => {
                console.error('Error fetching booked times:', error);
                bookedTablesByTime = {};
                bookedTablesBySlot = {};
                renderTimeSlots();
            });
        }

        function selectTimeSlot(slot, timeKey) {
            selectedSlot = slot;
            selectedSlot.timeKey = timeKey; // Store the time key for later use
            document.getElementById('tableSelection').classList.remove('hidden');
            document.getElementById('confirmationMsg').classList.add('hidden');
            
            // Update selected time visual state
            const timeButtons = document.querySelectorAll('#timeSlots button');
            timeButtons.forEach(button => {
                if (button.dataset.slot === slot.start + '-' + slot.end) {
                    button.classList.add('border-2', 'border-amber-600', 'bg-amber-50');
                } else {
                    button.classList.remove('border-2', 'border-amber-600', 'bg-amber-50');
                }
            });
            
            renderTables();
        }

        function renderTables() {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = '';
            
            if (!selectedSlot) return;
            
            // Get booked tables for this time slot
            const timeKey = selectedSlot.timeKey;
            const bookedTables = bookedTablesByTime[timeKey] || [];
            
            for (let i = 1; i <= TABLE_COUNT; i++) {
                const btn = document.createElement('button');
                btn.className = 'bg-white p-4 rounded-lg shadow text-center hover:shadow-md w-36 h-24 flex flex-col items-center justify-center cursor-pointer transition-all duration-200';
                
                const isBooked = bookedTables.includes(i);
                btn.disabled = isBooked;
                btn.dataset.table = i;
                
                if (isBooked) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-100');
                    btn.innerHTML = `
                        <h3 class="font-bold">Table ${i}</h3>
                        <span class="text-red-600 text-sm">Booked</span>
                    `;
                } else if (selectedTable === i) {
                    btn.classList.add('border-2', 'border-amber-600', 'bg-amber-50');
                    btn.innerHTML = `
                        <h3 class="font-bold">Table ${i}</h3>
                        <span class="text-green-600 text-sm">Selected</span>
                    `;
                } else {
                    btn.innerHTML = `
                        <h3 class="font-bold">Table ${i}</h3>
                        <span class="text-green-600 text-sm">Available</span>
                    `;
                }
                
                if (!isBooked) {
                    btn.onclick = () => showConfirmation(i);
                }
                grid.appendChild(btn);
            }
        }

        function showConfirmation(tableNumber) {
            const date = document.getElementById('reservationDate').value;
            if (!date || !selectedSlot) return;
            
            const formattedDate = new Date(date).toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const confirmMessage = `Are you sure you want to book Table ${tableNumber} on ${formattedDate} from ${convertTo12HourFormat(selectedSlot.start)} to ${convertTo12HourFormat(selectedSlot.end)}?`;
            
            if (window.confirm(confirmMessage)) {
                selectedTable = tableNumber;
                renderTables(); // Update visual selection
                bookTable(tableNumber);
            }
        }

        async function bookTable(tableNumber) {
            const date = document.getElementById('reservationDate').value;
            if (!date || !selectedSlot) return;
            
            const reservation_start = date + ' ' + selectedSlot.start + ':00';
            const reservation_end = date + ' ' + selectedSlot.end + ':00';
            
            const data = new URLSearchParams({
                action: 'create_reservation',
                table_number: tableNumber,
                reservation_start,
                reservation_end
            });
            
            document.getElementById('tableFeedback').textContent = 'Booking table...';
            
            try {
                const response = await fetch('../backend/reservation.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: data
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const formattedDate = new Date(date).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    
                    document.getElementById('confirmationText').innerHTML = `
                        Your reservation for Table ${tableNumber} on ${formattedDate} from ${convertTo12HourFormat(selectedSlot.start)} to ${convertTo12HourFormat(selectedSlot.end)} has been confirmed!
                        <div class="mt-4">
                            <button onclick="startNewReservation()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors mt-2">
                                Make Another Reservation
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('confirmationMsg').classList.remove('hidden');
                    document.getElementById('tableFeedback').textContent = '';
                    document.getElementById('tableSelection').classList.add('hidden');
                    
                    // Update the booked tables data
                    const timeKey = selectedSlot.timeKey;
                    if (!bookedTablesByTime[timeKey]) {
                        bookedTablesByTime[timeKey] = [];
                    }
                    bookedTablesByTime[timeKey].push(tableNumber);
                    
                } else {
                    document.getElementById('tableFeedback').textContent = result.error || 'Failed to make reservation';
                    fetchBookedTimes(); // Refresh data in case of errors
                }
            } catch (error) {
                document.getElementById('tableFeedback').textContent = 'Failed to make reservation';
                fetchBookedTimes(); // Refresh data in case of errors
            }
        }

        function startNewReservation() {
            selectedSlot = null;
            selectedTable = null;
            document.getElementById('confirmationMsg').classList.add('hidden');
            document.getElementById('tableSelection').classList.add('hidden');
            fetchBookedTimes();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('reservationDate');
            dateInput.min = today;
            dateInput.value = today;
            dateInput.addEventListener('change', function() {
                selectedSlot = null;
                selectedTable = null;
                document.getElementById('tableSelection').classList.add('hidden');
                document.getElementById('confirmationMsg').classList.add('hidden');
                fetchBookedTimes();
            });
            window.startNewReservation = startNewReservation;
            fetchBookedTimes();
        });
    </script>
</body>
</html>