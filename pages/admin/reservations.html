<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reservations | Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50">
  <nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-2">
          <i class="fas fa-utensils text-amber-600 text-2xl"></i>
          <h1 class="text-2xl font-bold text-amber-600">TableTop Admin</h1>
        </div>
        <div class="flex items-center space-x-4">
          <a href="dashboard.html" class="text-gray-700 hover:text-amber-600 transition-colors">Dashboard</a>
          <a href="menu.html" class="text-gray-700 hover:text-amber-600 transition-colors">Menu</a>
          <a href="orders.html" class="text-gray-700 hover:text-amber-600 transition-colors">Orders</a>
          <a href="feedback.html" class="text-gray-700 hover:text-amber-600 transition-colors">Feedback</a>
          <a href="reservations.html" class="text-amber-600 font-semibold border-b-2 border-amber-600">Reservations</a>
          <a href="../../pages/login.html" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors shadow-md login-btn">Login</a>
          <button id="mobile-menu-button" class="md:hidden text-gray-700"><i class="fas fa-bars text-2xl"></i></button>
        </div>
      </div>
      <div id="mobile-menu" class="md:hidden hidden py-4 border-t border-gray-100">
        <a href="dashboard.html" class="block py-2 text-gray-700 hover:text-amber-600">Dashboard</a>
        <a href="menu.html" class="block py-2 text-gray-700 hover:text-amber-600">Menu</a>
        <a href="orders.html" class="block py-2 text-gray-700 hover:text-amber-600">Orders</a>
        <a href="feedback.html" class="block py-2 text-gray-700 hover:text-amber-600">Feedback</a>
        <a href="reservations.html" class="block py-2 text-amber-600 font-semibold border-b-2 border-amber-600">Reservations</a>
      </div>
    </div>
  </nav>

  <main class="container mx-auto p-6">
    <div class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-2xl font-bold text-gray-900">Table Reservations</h2>
        <div class="flex gap-3">
          <input type="date" id="dateFilter" 
                 class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
          <select id="statusFilter" 
                  class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Table</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="reservationsList" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Status Update Modal -->
  <div id="statusModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg max-w-md w-full mx-4 shadow-lg">
      <h3 class="text-2xl font-bold mb-6">Update Reservation Status</h3>
      <form id="statusForm" class="space-y-6">
        <input type="hidden" id="reservationId">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <select id="newStatus" required 
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
            <option value="confirmed">Confirm</option>
            <option value="cancelled">Cancel</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
          <textarea id="statusNotes" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"
                    rows="3"></textarea>
        </div>
        <div class="flex justify-end gap-4">
          <button type="button" onclick="closeModal()" 
                  class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
            Cancel
          </button>
          <button type="submit" 
                  class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-2 rounded-lg transition-colors shadow-md">
            Update
          </button>
        </div>
      </form>
    </div>
  </div>

  <footer class="bg-gray-800 text-white py-16 mt-20">
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
        <div>
          <h4 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-utensils text-amber-500 mr-3"></i>
            TableTop
          </h4>
          <p class="text-gray-400 mb-6">Admin dashboard for TableTop restaurant management.</p>
        </div>
        <div>
          <h4 class="text-lg font-semibold mb-6">Quick Links</h4>
          <ul class="space-y-3">
            <li><a href="dashboard.html" class="text-gray-400 hover:text-amber-500 transition-colors flex items-center"><i class="fas fa-chevron-right mr-2 text-amber-500"></i> Dashboard</a></li>
            <li><a href="menu.html" class="text-gray-400 hover:text-amber-500 transition-colors flex items-center"><i class="fas fa-chevron-right mr-2 text-amber-500"></i> Menu</a></li>
            <li><a href="orders.html" class="text-gray-400 hover:text-amber-500 transition-colors flex items-center"><i class="fas fa-chevron-right mr-2 text-amber-500"></i> Orders</a></li>
            <li><a href="feedback.html" class="text-gray-400 hover:text-amber-500 transition-colors flex items-center"><i class="fas fa-chevron-right mr-2 text-amber-500"></i> Feedback</a></li>
            <li><a href="reservations.html" class="text-amber-500 flex items-center"><i class="fas fa-chevron-right mr-2 text-amber-500"></i> Reservations</a></li>
          </ul>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-12 pt-8 text-center">
        <p class="text-gray-400">&copy; 2025 TableTop. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById('mobile-menu-button').addEventListener('click', function() {
      const mobileMenu = document.getElementById('mobile-menu');
      mobileMenu.classList.toggle('hidden');
    });

    // Session check and UI update
    async function checkSessionAndUpdateUI() {
      const nav = document.querySelector('nav .flex.items-center.space-x-4');
      let loginBtn = nav.querySelector('a.login-btn');
      let logoutBtn = nav.querySelector('.logout-btn');
      if (logoutBtn) logoutBtn.remove();
      try {
        const res = await fetch('../../backend/auth.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ action: 'check_session' })
        });
        const data = await res.json();
        if (data.logged_in && data.role === 'admin') {
          if (loginBtn) loginBtn.style.display = 'none';
          const logout = document.createElement('a');
          logout.textContent = 'Logout';
          logout.href = '#';
          logout.className = 'bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors shadow-md logout-btn';
          logout.onclick = async function(e) {
            e.preventDefault();
            await fetch('../../backend/auth.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: new URLSearchParams({ action: 'logout' })
            });
            window.location.href = '../../index.html';
          };
          nav.appendChild(logout);
        } else {
          if (loginBtn) loginBtn.style.display = '';
          window.location.href = '../../pages/login.html';
        }
      } catch (e) {
        if (loginBtn) loginBtn.style.display = '';
        window.location.href = '../../pages/login.html';
      }
    }
    document.addEventListener('DOMContentLoaded', checkSessionAndUpdateUI);

    // Toast feedback
    function showToast(msg, type = 'info') {
      let toast = document.createElement('div');
      toast.className = `fixed bottom-8 right-8 z-50 px-6 py-3 rounded shadow-lg text-white font-semibold ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-amber-600'}`;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 3000);
    }

    let currentDate = new Date().toISOString().split('T')[0];
    let currentStatus = 'all';

    document.getElementById('dateFilter').value = currentDate;
    
    function openStatusModal(reservation) {
      document.getElementById('reservationId').value = reservation.id;
      document.getElementById('newStatus').value = 'confirmed';
      document.getElementById('statusNotes').value = '';
      document.getElementById('statusModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('statusModal').classList.add('hidden');
    }

    document.getElementById('dateFilter').onchange = function(e) {
      currentDate = e.target.value;
      loadReservations();
    };

    document.getElementById('statusFilter').onchange = function(e) {
      currentStatus = e.target.value;
      loadReservations();
    };

    document.getElementById('statusForm').onsubmit = async function(e) {
      e.preventDefault();
      const formData = {
        action: 'update_reservation',
        id: document.getElementById('reservationId').value,
        status: document.getElementById('newStatus').value,
        notes: document.getElementById('statusNotes').value
      };

      try {
        const res = await fetch('../../backend/reservation.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(formData)
        });
        const data = await res.json();
        if (data.success) {
          showToast('Reservation updated!', 'success');
          closeModal();
          loadReservations();
        } else {
          showToast(data.error || 'Failed to update reservation', 'error');
        }
      } catch (error) {
        showToast('Failed to update reservation', 'error');
      }
    };

    function loadReservations() {
      fetch(`../../backend/reservation.php?action=get_reservations&date=${currentDate}&status=${currentStatus}`)
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById('reservationsList');
          tbody.innerHTML = '';
          if (data.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                  No reservations found
                </td>
              </tr>
            `;
            return;
          }
          data.forEach(res => {
            const tr = document.createElement('tr');
            const statusColors = {
              pending: 'bg-yellow-100 text-yellow-800',
              confirmed: 'bg-green-100 text-green-800',
              cancelled: 'bg-red-100 text-red-800'
            };
            tr.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${res.id}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${res.customer_name}</div>
                <div class="text-sm text-gray-500">${res.customer_email}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                Table ${res.table_number}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${new Date(res.reservation_date).toLocaleDateString()}</div>
                <div class="text-sm text-gray-500">${res.reservation_time}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-3 py-1 text-xs rounded-full ${statusColors[res.status]}">
                  ${res.status}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                ${res.status === 'pending' ? `
                  <button onclick='openStatusModal(${JSON.stringify(res)})' 
                          class="text-amber-600 hover:text-amber-700 font-medium">
                    Update Status
                  </button>
                ` : ''}
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
    }

    // Close modal when clicking outside
    document.getElementById('statusModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    // Initial load
    loadReservations();
  </script>
</body>
</html>