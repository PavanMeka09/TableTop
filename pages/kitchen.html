<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen Display | TableTop</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50">
  <nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-2">
          <i class="fas fa-utensils text-amber-600 text-2xl"></i>
          <h1 class="text-2xl font-bold text-amber-600">TableTop Kitchen</h1>
        </div>
        <a href="../backend/auth.php?action=logout" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors shadow-md">Logout</a>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-bold">Active Orders</h2>
      <div class="flex space-x-3">
        <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">Pending</span>
        <span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm font-medium">Preparing</span>
      </div>
    </div>

    <div id="orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Orders will be populated here -->
    </div>
  </main>

  <script>
    async function fetchOrders() {
      try {
        const response = await fetch('../backend/kitchen.php');
        const data = await response.json();

        if (data.error) {
          alert(data.error);
          return;
        }

        const ordersContainer = document.getElementById('orders');
        ordersContainer.innerHTML = '';

        if (data.length === 0) {
          ordersContainer.innerHTML = `
            <div class="col-span-full text-center py-12">
              <p class="text-gray-500">No active orders</p>
            </div>
          `;
          return;
        }

        data.forEach(order => {
          const orderDiv = document.createElement('div');
          orderDiv.className = 'bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow';
          
          const statusColor = order.status === 'pending' 
            ? 'bg-yellow-100 text-yellow-800'
            : 'bg-amber-100 text-amber-800';

          orderDiv.innerHTML = `
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="font-bold text-lg">Order #${order.id}</h3>
                <p class="text-sm text-gray-500 mt-1">${new Date(order.created_at).toLocaleString()}</p>
              </div>
              <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                ${order.status}
              </span>
            </div>
            <div class="space-y-3">
              ${order.items.map(item => `
                <div class="flex justify-between items-center py-2 border-b">
                  <div class="flex items-center">
                    <span class="bg-amber-100 text-amber-800 w-8 h-8 rounded-full flex items-center justify-center font-medium mr-3">
                      ${item.quantity}x
                    </span>
                    <span class="font-medium">${item.name}</span>
                  </div>
                  <span class="text-gray-600">₹${item.price}</span>
                </div>
              `).join('')}
            </div>
            <div class="mt-4 pt-4 border-t flex justify-between items-center">
              <button onclick="updateStatus(${order.id}, '${order.status === 'pending' ? 'preparing' : 'on the way'}')"
                      class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-colors">
                ${order.status === 'pending' ? 'Start Preparing' : 'Mark Ready'}
              </button>
              <p class="text-xl font-bold text-amber-600">₹${order.total_price}</p>
            </div>
          `;
          ordersContainer.appendChild(orderDiv);
        });
      } catch (error) {
        console.error('Error fetching orders:', error);
      }
    }

    async function updateStatus(orderId, newStatus) {
      try {
        const response = await fetch('../backend/order.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            action: 'update_status',
            order_id: orderId,
            status: newStatus
          })
        });
        const data = await response.json();
        if (data.success) {
          fetchOrders(); // Refresh the orders
        } else {
          alert(data.error || 'Failed to update status');
        }
      } catch (error) {
        console.error('Error updating status:', error);
      }
    }

    // Fetch orders initially and refresh every 30 seconds
    fetchOrders();
    setInterval(fetchOrders, 30000);
  </script>
</body>
</html>